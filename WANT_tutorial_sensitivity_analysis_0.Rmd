---
title: "Template for practicals"
author: "The WANT team"
date: "24/08/2018"
output:
  html_document:
    css: want.css
---

<!-- include the hint.js -->
<script src="hints.js"></script>

# Learning goals
* Understand the concept of local sensitivity analysis
* Understand the limitations of local sensitivity analysis 

# Introduction
In this assignment, we will manually work out the local sensitivity at several places for several functions. The idea is that you can do these calculations by hand. 

# Assignment 1
We have a linear function $y = ax + b$, with parameters $a$ and $b$. 

<span class="question">
Plot the function $y$ for the domain $x = [0, 10]$ in the code chunk below. Base values for $a$ and $b$ are 3 and 7, respectively. Which of the two parameters, $a$ or $b$ do you expect to be of more influence on y? 
</span>

```{r}
# Type your code here.
```

<span class="student_answer">
Fill in your answer...
</span>

<span class="answer">
```{r}
x = seq(0,10,1)
a = 3
b = 7
y = a*x + b
plot(x,y,type="o")
```
This is a linear function, where $a$ is the slope of the function and $b$ the intersect. Depending on where we will evaluate sensitivity on, probably $y$ is more sensitive to $a$.
</span>

<span class="question">
Determine the sensitivity of y for $a$ and $b$ with the given base-values and for x=[0:10]. You can do this manually, or use R as calculator.  
</span>

<!-- Here a hint is implemented. Argument to showHint is the QUESTION_NUMBER as documented in the hints.js file.
The position the hint is displayed where a paragraph text with id = Q + QUESTION_NUMBER is entered. -->
<button type="button" onclick="showHint(1)">During the lectures, we only evaluated the influence of different parameters on a single value (in the example discused in the lectures, this was the maximum groundwater level). In this exercise, you suddenly deal with a vector of 10 values. What we need in order to determine the sensitivity, is a way of expressing changes in the vector $y$ in a single value. The sums of squares could be a good option. </button>
<p id="Q1"> </p>
<!-- Here a hint is implemented. Argument to showHint is the QUESTION_NUMBER as documented in the hints.js file.
The position the hint is displayed where a paragraph text with id = Q + QUESTION_NUMBER is entered. -->
<button type="button" onclick="showHint(2)">The sums of squares can be obtained as follows: SS = $\sum_1^{10}(y_{base}-y_{change})^2$ </button>
<p id="Q2"> </p>


```{r}
# Type your code here.
```

<span class="answer">
```{r}
# y of base values from previous assignment
x = seq(0,10,1)
a = 3
b = 7
y_base = a*x + b

# sensitivity for a
a_change = 3.1 
b = 7
y_change = a_change*x + b
SS_a = sum(y_base-y_change)^2
# so the local sensitivity is (SS from the base value is obviously zero and is therefore not included):
LSA_a = SS_a / (a_change-a)
print(LSA_a)

# sensitivity for b
a = 3 
b_change = 7.1
y_change = a*x + b_change
SS_b = sum(y_base-y_change)^2
# so the local sensitivity is (SS from the base value is obviously zero and is therefore not included):
LSA_b = SS_b / (b_change-b)
print(LSA_b)

# In this particular example, $a$ and $b$ have no units, and we do not specify a scale of variation, because we are not investigating a physical system with clearly defined boundary conditions. Therefore, we can directly interpret the restuls obtained above. This shows that our model $y$ is more sensitive to parameter $a$ than to parameter $b$, given that we evaluate $y$ based on the SS-metric. 

```
</span>

<span class="question">
Same as above, but now use base values 0.5 and 60 respectively for  $a$ and $b$. Do you expect that this will influence the sensitivity and why (not)? 
</span>


```{r}
# Type your code here.
```

<span class="answer">
```{r}
# In this particular case, we know that different base values will not lead to a different sensitivity, because it is a linear function. Over linear functions, the sensitivity is constant over the complete function. We can simply check this with repeating the calculation: 

# y of base values 
x = seq(0,10,1)
a = 0.5
b = 60
y_base = a*x + b

# sensitivity for a
a_change = 0.6 
b = 60
y_change = a_change*x + b
SS_a = sum(y_base-y_change)^2
# so the local sensitivity is (SS from the base value is obviously zero and is therefore not included):
LSA_a = SS_a / (a_change-a)
print(LSA_a)

# sensitivity for b
a = 0.5 
b_change = 60.1
y_change = a*x + b_change
SS_b = sum(y_base-y_change)^2
# so the local sensitivity is (SS from the base value is obviously zero and is therefore not included):
LSA_b = SS_b / (b_change-b)
print(LSA_b)

```
</span>


# Assignment 2
Most systems in environmental sciences behave non-linear. We will now evaluate a simple non-linear function: 
$y = ax^2+bx$

<span class="question">
Plot the function $y = ax^2+bx$ for the domain $x = [0, 10]$ in the code chunk below. Base values for $a$ and $b$ are 3 and 7. Which parameter do you expect to be of more influence on y? 
</span>

```{r}
# Type your code here.
```

<span class="answer">
```{r}
x = seq(0,10,1)
a = 3
b = 7
y = a*x^2 + b*x
plot(x,y,type="o")
```
Generally, we would expect y to be more sensitive to a, because this parameter relates to x squared. 
</span>


<span class="question">
For the function $y = ax^2+bx$ for the domain $x = [0, 10]$, calculate the sensitivity of $y$ for $a$ and $b$ for 1) base values of 3 and 7 respectively, and 2) base values of 0.5 and 60 respectively. Does the base value influence the sensitivity? 
</span>


```{r}
# Type your code here.
```

<span class="answer">
```{r}
# 1) base values
x = seq(0,10,1)
a = 3
b = 7
y_base = a*x^2 + b*x

a_change = 3.1
b        = 7
y_a      = a_change*x^2 + b*x
SS_a     = sum(y_base-y_a)^2
LSA_a1   = SS_a / (a_change-a)

a        = 3
b_change = 7.1
y_b      = a*x^2 + b_change*x
SS_b     = sum(y_base-y_b)^2
LSA_b1   = SS_b / (b_change-b)

# 2) base values
x = seq(0,10,1)
a = 0.5
b = 60
y_base = a*x^2 + b*x

a_change = 0.51
b        = 60
y_a      = a_change*x^2 + b*x
SS_a     = sum(y_base-y_a)^2
LSA_a2   = SS_a / (a_change-a)

a        = 0.5
b_change = 60.1
y_b      = a*x^2 + b_change*x
SS_b     = sum(y_base-y_b)^2
LSA_b2   = SS_b / (b_change-b)

# change in a:
LSA_a1-LSA_a2
# change in b:
LSA_b1-LSA_b2
```
So, the sensitivity for parameter $a$ changed with different base values, while the sensitivity for parameter $b$ did not change. This can be understood from the equation; $b$ is only linearly related to x, and we've seen that for linear equations the sensitivity does not change. Parameter $a$, however, is related to the square root of x, thereby being not linear and as such, sensitivity changes for different base values. Since most systems in environmental sciences behave non-linearly, choosing the base values carefully is therefore very important.  
</span>

# Add an assignment with sensitivity over x? or a highly non-linear function? Or local global sensitivity analysis? 
# Extra assignment - global local sensitivity analysis 

<span class="question">
We have a function $y = ax^3+bx^2+cx$ for the domain $x = [0, 10]$ to describe a process in a natural system. We don't know the base values of parameters $a$, $b$, and $c$, just that, because of physical boundaries, all parameters can vary between 0 and 20. We do have observations of variable $y$, $y_{obs}$, provided below. 
```{r}
y_obs=c(0.1,22.4,140.8,434.2,978.2,1852.3,3134.9,4903.4,7236.1,10210.4,13903.9)
```
Calculate the sensitivity of $y$ to the three parameters over the complete parameter space. 

<!-- Here a hint is implemented. Argument to showHint is the QUESTION_NUMBER as documented in the hints.js file.
The position the hint is displayed where a paragraph text with id = Q + QUESTION_NUMBER is entered. -->
<button type="button" onclick="showHint(1)">Ai, we don't know any base values. So where do we start? We can make two choices here; either we assume that all parameters are completely independent and we make a latin hypercube sample to efficiently run through parameter space, or we just run all possible combinations over the complete parameter space, with a given step size. We can determine the step size based on the amount of runs needed. A step size of 0.1 would result in 201 samples per parameter, running all combinations yiels $201^3=8120601$ runs, perhaps a bit too much at this stage. Therefore, we can start with a step size of 1, which yields $21^3=9261$ runs.  </button>
<p id="Q1"> </p>

-> here we can refer to latin hypercube sampling stragies (is not dealt with in the lectures yet)
-> here we can also refer to the curse of dimensionality

```{r}
# Type your code here.
```

<span class="answer">
```{r}
par_sample = seq(0,20,1) # vector with all parameter values that will be checked
LSA_a      = matrix(nrow=9261,ncol=2)
LSA_b      = matrix(nrow=9261,ncol=2)
LSA_c      = matrix(nrow=9261,ncol=2)

# start value for counter
n_a = 1 
n_b = 1
n_c = 1

for (i in 1:length(par_sample)){
  for (j in 1:length(par_sample)){
   for (k in 1:length(par_sample)){
     
     # assign parameter values
     a_low = par_sample[i]
     b_low = par_sample[i]
     c_low = par_sample[i]
     
     a_mid   = par_sample[j]
     b_mid   = par_sample[j]
     c_mid   = par_sample[j]
     
     a_high   = par_sample[k]
     b_high   = par_sample[k]
     c_high   = par_sample[k]
     
     # combine them into the model
     # for parameter a
     a = a_high
     b = b_low
     c = c_mid

     y_base = a*x^3+b*x^2+c*x
     
SS_b     = sum(y_base-y_b)^2
LSA_b1   = SS_b / (b_change-b)
     
     
   } 
  }
}
```
</span>







This is the end. My only friend, the end. 
