---
title: "Template for practicals"
author: "The WANT team"
date: "24/08/2018"
output:
  html_document:
    css: want.css
---

<!-- include the hint.js -->
<script src="hints.js"></script>

# Learning goals
* Understand the concept of local sensitivity analysis
* Understand the imlications and limitations of local sensitivity analysis 

# Introduction
In this assignment, we will manually work out the local sensitivity at several places for several functions. The idea is that you can do these calculations by hand (or support by R). 

# Assignment 1
We have a linear function $y = ax + b$, with parameters $a$ and $b$. 

<span class="question">
Plot the function $y$ for the domain $x = [0, 10]$ in the code chunk below. Base values for $a$ and $b$ are 3 and 7, respectively. Which of the two parameters, $a$ or $b$ do you expect to be of more influence on y? 
</span>

```{r}
# Type your code here.
```

<span class="student_answer">
Fill in your answer...
</span>

<span class="answer">
```{r}
x = seq(0,10,1)
a = 3
b = 7
y = a*x + b
plot(x,y,type="o")
```
This is a linear function, where $a$ is the slope of the function and $b$ the intersect. Depending on where we will evaluate sensitivity on, probably $y$ is more sensitive to $a$.
</span>

<span class="question">
Determine the sensitivity of y for $a$ and $b$ with the given base-values and for x=[0:10]. You can do this manually, or use R as calculator.  
</span>


<!-- HINT 1 -->
<button type="button" onclick="showHint(1)">Hint 1</button>
<p id="Q1"> </p>
<!-- HINT 2 -->
<button type="button" onclick="showHint(2)">Hint 2</button>
<p id="Q2"> </p>


```{r}
# Type your code here.
```

<span class="answer">
```{r}
# y of base values from previous assignment
x = seq(0,10,1)
a = 3
b = 7
y_base = a*x + b

# sensitivity for a
a_change = 3.1 
b = 7
y_change = a_change*x + b
SS_a = sum((y_base-y_change)^2)
# so the local sensitivity is (SS from the base value is obviously zero and is therefore not included):
LSA_a = SS_a / (a_change-a)
print(LSA_a)

# sensitivity for b
a = 3 
b_change = 7.1
y_change = a*x + b_change
SS_b = sum((y_base-y_change)^2)
# so the local sensitivity is (SS from the base value is obviously zero and is therefore not included):
LSA_b = SS_b / (b_change-b)
print(LSA_b)

# In this particular example, $a$ and $b$ have no units, and we do not specify a scale of variation, because we are not investigating a physical system with clearly defined boundary conditions. Therefore, we can directly interpret the restuls obtained above. This shows that our model $y$ is more sensitive to parameter $a$ than to parameter $b$, given that we evaluate $y$ based on the SS-metric. 

```
</span>

<span class="question">
Same as above, but now use base values 0.5 and 60 respectively for  $a$ and $b$. Do you expect that this will influence the sensitivity and why (not)? 
</span>


```{r}
# Type your code here.
```

<span class="answer">
```{r}
# In this particular case, we know that different base values will not lead to a different sensitivity, because it is a linear function. Over linear functions, the sensitivity is constant over the complete function. We can simply check this with repeating the calculation: 

# y of base values 
x = seq(0,10,1)
a = 0.5
b = 60
y_base = a*x + b

# sensitivity for a
a_change = 0.6 
b = 60
y_change = a_change*x + b
SS_a = sum((y_base-y_change)^2)
# so the local sensitivity is (SS from the base value is obviously zero and is therefore not included):
LSA_a = SS_a / (a_change-a)
print(LSA_a)

# sensitivity for b
a = 0.5 
b_change = 60.1
y_change = a*x + b_change
SS_b = sum((y_base-y_change)^2)
# so the local sensitivity is (SS from the base value is obviously zero and is therefore not included):
LSA_b = SS_b / (b_change-b)
print(LSA_b)

```
</span>


# Assignment 2
Most systems in environmental sciences behave non-linear. We will now evaluate a simple non-linear function: 
$y = ax^2+bx$

<span class="question">
Plot the function $y = ax^2+bx$ for the domain $x = [0, 10]$ in the code chunk below. Base values for $a$ and $b$ are 3 and 7. Which parameter do you expect to be of more influence on y? 
</span>

```{r}
# Type your code here.
```

<span class="answer">
```{r}
x = seq(0,10,1)
a = 3
b = 7
y = a*x^2 + b*x
plot(x,y,type="o")
```
Generally, we would expect y to be more sensitive to a, because this parameter relates to x squared. 
</span>


<span class="question">
For the function $y = ax^2+bx$ for the domain $x = [0, 10]$, calculate the sensitivity of $y$ for $a$ and $b$ for 1) base values of 3 and 7 respectively, and 2) base values of 0.5 and 60 respectively. Does the base value influence the sensitivity? 
</span>


```{r}
# Type your code here.
```

<span class="answer">
```{r}
# 1) base values
x = seq(0,10,1)
a = 3
b = 7
y_base = a*x^2 + b*x

a_change = 3.1
b        = 7
y_a      = a_change*x^2 + b*x
SS_a     = sum((y_base-y_a)^2)
LSA_a1   = SS_a / (a_change-a)

a        = 3
b_change = 7.1
y_b      = a*x^2 + b_change*x
SS_b     = sum((y_base-y_b)^2)
LSA_b1   = SS_b / (b_change-b)

# 2) base values
x = seq(0,10,1)
a = 0.5
b = 60
y_base = a*x^2 + b*x

a_change = 0.51
b        = 60
y_a      = a_change*x^2 + b*x
SS_a     = sum((y_base-y_a)^2)
LSA_a2   = SS_a / (a_change-a)

a        = 0.5
b_change = 60.1
y_b      = a*x^2 + b_change*x
SS_b     = sum((y_base-y_b)^2)
LSA_b2   = SS_b / (b_change-b)

# change in a:
LSA_a1-LSA_a2
# change in b:
LSA_b1-LSA_b2
```
So, the sensitivity for parameter $a$ changed with different base values, while the sensitivity for parameter $b$ did not change. This can be understood from the equation; $b$ is only linearly related to x, and we've seen that for linear equations the sensitivity does not change. Parameter $a$, however, is related to the square root of x, thereby being not linear and as such, sensitivity changes for different base values. This implies that, even though the sensitivity for $b$ in itself does not change, the ratio of sensitivity between $b$ and $a$ changes:


```{r}
par(mfrow=c(2,1))
pie(c(LSA_a1,LSA_b1),labels=c('a','b'),col=c("red","blue"))
pie(c(LSA_a2,LSA_b2),labels=c('a','b'),col=c("red","blue"))

```

Since most systems in environmental sciences behave non-linearly, choosing the base values carefully is therefore very important.  
</span>

# Extra assignment
Run over all values for a and b between 0.1 and 20 and plot how the relative sensitivity changes. 

<!-- HINT 3 -->
<button type="button" onclick="showHint(3)">Hint 3</button>
<p id="Q3"> </p>

```{r}
# Type your code here.
```

<span class="answer">
```{r}
# vector with all parameter values that will be checked
par_sample = seq(0.1,20,0.1) 
LSA_a      = matrix(nrow=length(par_sample),ncol=2)
LSA_b      = matrix(nrow=length(par_sample),ncol=2)

for (i in 1:length(par_sample)){
     # assign base values
     a_base  = par_sample[i]
     b_base  = par_sample[i]
     
     # calculate base y
     y_base = a_base*x^2+b_base*x
     
     # calculate perturbed y
     y_a   = (a_base+0.1)*x^2 + 4*x
     y_b   = a_base*x^2 + (b_base+0.1)*x
     
     # calculate SS
     SS_a     = sum((y_base-y_a)^2)
     SS_b     = sum((y_base-y_b)^2)
     
     # calculate LSA and store in vector
     LSA_a[i,1]   = par_sample[i]
     LSA_a[i,2]   = SS_a / 0.1 
     LSA_b[i,1]   = par_sample[i]
     LSA_b[i,2]   = SS_b / 0.1 
}

```









This is the end. My only friend, the end. 
