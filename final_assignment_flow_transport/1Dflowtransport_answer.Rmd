---
title: "1D Flow & Transport modeling"
author: "G.Bier, P.Torfs"
output:
  html_notebook:
    css: want.css
    number_sections: yes
    toc: yes
  html_document:
    css : want.css
    df_print: paged
    toc: yes
---

```{r}
rm(list = ls())
library(FVFE1D)
```

# Learning Goals  

* Understand the use of the Convection Diffusion/Dispersion Equation in the context of solute transport modeling.
* Derive physical dimensions and properties related to solute transport modeling.  
* Setup flow and transport models in a 1D or pseudo 2D environment using proper units.  
* Critically evaluate the numerical aspects of the solutions (Courant and Peclet numbers).  
* Setup water and mass balances for both types of models and analyse the result.
* Carry out a local sensitivity analyses of various parameters w.r.t. the outcome of both models

# Introduction  


In this exercise the basic Convection Diffusion Equation (CDE) as discussed during the lectures will be reviewed and an analysis of the appropriate dimensions/units will be discussed. As an example we will consider the leakage of a contaminant from a vessel on the surface into the saturated groundwater towards a local brook.  
First the equations (i.e. the internal fluxes) to setup a 1- (pseudo 2-) dimensional flow and 1- (pseudo 2-) dimensional transport model need to be derived and implemented. Specific attention is paid to the translation of the flow, volume, density and mass into the proper units for the flow and transport problem.   
After the stationary flow model is run, the stationary transport model is run based on the local water velocities and saturated thickness of the flow model transporting the contaminants towards the brook.  
The following assignment will be to analyse the effect of remediating the spill based on local groundwater flow only and with the aid of a pump and treat scenario.  
Finally a local sensitivity analysis is carried out analyzing the effects of various variables and parameters of both models on their results.  

The convection diffusion equation as discussed during the lectures is:
$$
\frac{\partial s}{\partial t}=-v \frac{\partial s}{\partial x}+D \frac{\partial^2 s}{\partial x^2}
$$

which is a mass balance for the particular state (s);  
With:

* $\frac{\partial s}{\partial t}$: mass storage change during time  
* $v \frac{\partial s}{\partial x}$: convective(advective) mass flux  
* $D \frac{\partial^2 s}{\partial x^2}$: diffusive/dispersive mass flux  

All the above terms (obviously) have dimensions: $\frac{\text{mass}}{\text{volume time}}$ and when multiplied with the appropriate control volume based on the finite volume or finite element techniques it results in a mass flux of $\frac{\text{mass}}{time}$ per time step.  

Retardation (add/desoprtion properties of a solute which effectively slows down the convection and diffusion processes) and decay are omitted from this equation for simplicity and will not be considered in the simulations.

The convective part of this equation is based on the mass influx into (or out of) an elementary volume (e.g. a cube): 
$$
qC\,\,\text{or}\,\, v \text{por}C
$$  
Where:  

* $q$: Flux rate into (or out of) a face of the elementary volume (length/time)  
* $\text{por}$ : porosity of the soil ($\frac{m^3}{m^3}$)
* $C$: Concentration of the solute (mass/volume)  

The convective part couples groundwater to solute transport since this $q$ is determined by the groundwater model.  

The diffusive part it is based on the equation of Fick (first law) which resembles Darcy's equation:
$$
J=-D\frac{\partial C}{\partial x}
$$

Where:  

* $J$: Diffusion flux (rate)  (mass/time)  
* $D$: Diffusivity of Diffusion coefficient length$^2$/time


<div class="question">
Why is there a negative sign in the above equation?
</div>

<div class="answer">
The diffusion flux goes towards the lower concentration. So if that is into the $x$ direction $C_{x+\Delta x}$ is lower than $C_{x}$. Therefor, and similar like the Darcy equation the negative sign makes the flux to go in the proper direction.  
</div>


<div class="question">
When using the following units:

* length $\mathsf{m}$  
* mass $\mathsf{kg}$  
* concentration $\mathsf{kg/m^3}$  
* time $d$  

What is the unit for the following variables when one assumes 3 dimensional flow and transport?  

* $D$  
* $q$  
* $C$  
* $J$
</div>

<div class="answer">

* $D$ : $\mathsf{m^2/d}$ 
* $q$ : $\mathsf{m/d}$
* $C$ : $\mathsf{kg/m^3}$
* $J$ : $\mathsf{kg/d}$
</div>

In this assignment we consider the concentration of a solute to be the __only__ amount of mass in a __unit volume__ of groundwater. However in reality a concentration of e.g. 35 $kg/m^3$ of salt in a volume of 1000 liters groundwater will have a __density__ of about 1025 $kg/m^3$ (also depending on pressure, viscosity and temperature). So although $C$ and $\rho$ do have the same unit, they are different in the way we calculate them. By the way, flow due to density differences are also not considered here!  

# Groundwater flow model  

The model for stationary groundwater flow consists of one phreatic aquifer (k = 3[$\mathsf{m/d}$]) for which the bottom tilts from left to right. The total length of the model is 200 m, use a nodal distance of 5 m. At the left boundary a river with an open water level of 3 m Above Mean Sea Level (AMSL) is situated, the right boundary is based on a water divide. On top a uniform recharge om 1 mm/d is applied.  
The bottom of the aquifer has an altitude of 1 m AMSL on the left and slopes downwards towards the right with 5 m/km.  
At a later stage an extraction well will be added to the model.  
To determine specific volume fluxes the porosity of the soil is required and is here estimated on 30%.  
Figure 2 illustrates the situation;

![**Figure 2**: Sketch of the field situation including a point source  ](flow_transportmodel_ref.png)

## Internal groundwater flux  

The model which calculates the water(volume)flux is based on a flux rate integrated over the saturated thickness;
$$
q_D = -kD_{sat}(x)\frac{\partial H}{\partial x}
$$
Which makes this flux rate quasi 2D; the $_D$ in $q_D$ is to indicate that its a flux over the total saturated thickness.   

$D_{sat}$: The saturated thickness over which flow takes place ($m$).

<div class="question">
* What is the unit of this flux rate $q_D$ for this model?
</div>
<div class="answer">
 * $q_D(x)$: the flux integrated over the saturated thickness $D_{sat}(x)$ per $\Delta y$ so $\mathsf{m^3/(d m)}$ which is simply $\mathsf{m^2/d}$
</div>

The following illustration clarifies some dimensions of the flow in the 1D(or quasi 2D) model;  

![**Figure 1**: Sketch of different properties and the three spatial dimensions of groundwater flow](Dupuit_flow.png)



The volume groundwater in a slice of soil is now : $\text{por}\Delta x \Delta y$  (check the units!). But since we consider a quasi 2-D model the $\Delta y$ is not considered in the equations. In other words, the volume of groundwater in a slice ($\Delta x$) of soil is $m^3/m$, the $/m$ indicating the "per meter $\Delta y$.

<div class="question">


* How would you derive the water velocity this groundwater flow model?

</div>
<div class="answer">

 * To come from Darcy's flux "density"to velocity: $v = \frac{q}{\text{porosity}}$. The water flow takes place in the pores

 
</div>

## Boundary conditions  

Possible boundary conditions for the groundwater flow model are based on:

1. Dirichlet type 
2. Neumann type
3. Cauchy type 

<div class="question">
implement the appropriate boundary conditions; 
the prescribed river level left and  
the water divide on the right
</div>

<div class="answer">

* left is a Dirichlet boundary condition with a prescribed level of 3 m AMSL
* right is a Neumann bounary condition for no action is required
</div>

## Setup groundwater flow model  

<div class="question">
1. Setup this flow model and give it a distinctive name e.g. Fmodel or Flowmodel or so. 
   a. Use the `do.initialize()` function to avoid numerical problems due to the non-linear character of the internal flux flunction.
2. Run the model and look at the results; head distribution, internal flux and water balance terms.  
3. Create a plot showing both the calculated head and the bottom of the aquifer.  
</div>

<div class="answer">
1. Model setup of the groundwater flow model  

```{r}
#model domain
bnd.left = 0 #m boundary at left
bnd.right = 200 #m boundary at right
domain = c(bnd.left,bnd.right)
#sloping aquifer
bot.left =1
bot.right = bot.left - 5/1000*bnd.right
bottom = approxfun(x = domain,y = c(bot.left,bot.right))

#properties
k = 3 #m/d
precip = 0.001 #m/d
fix.H = 3
por = 0.3
#math model& boundary conditions

Darcy <- function(x,head,gradH) 
{
  return(-k*(head-bottom(x))*gradH)
}

Fmodel = newFLOW1D(domain = domain,systemfluxfunction = Darcy,name = "Stationary flow model ")
set.BC.fixedstate(Fmodel,'left',fix.H)
add.spatialflux(model = Fmodel,rate = 'precip',name = 'precipitation')
# numerical model
delta.x = 5 #m
nodes = seq(from=domain[1],to = domain[2],by=delta.x)
set.discretisation(model = Fmodel,nodes=nodes,method='FV')
do.initialize(model = Fmodel,init = 1.0) # otherwise problems with non-linearity of the Darcy function
summary(Fmodel)



```

2. Solving this model and plotting the results
```{r}
#solve
solve.steps(Fmodel)

#results
plot(Fmodel,fluxplot = T,FVstyle = T)
dataframe.balance(Fmodel)
```

3. A plot of the head distribution and the aquifer bottom elevation
```{r}
#plot with heads and aquifer bottom elevation
level.range =range(Fmodel$states,bottom(nodes))
plot(nodes,Fmodel$states,type="o",col="red",lwd=3,main = "head and bottom of the model",
     ylab="level (m)",xlab="distance (m)",ylim=level.range)
lines(nodes,bottom(nodes),col='brown',lwd=3)
grid()
```


</div>

To determine the mass in the solute transport model the saturated thickness is required.  

<div class="question">  

* Make a function and a plot of the saturated thickness. Call the function e.g. D.sat .
</div>
<div class="answer">
See below

```{r}
D.sat = approxfun(nodes,Fmodel$states-bottom(nodes))
plot(nodes,D.sat(nodes),type="o", main='saturated thicknes (m)',
     ylab="saturated thickness (m)",lwd=3)
grid()
```
</div>

## Flux and Volume functions for the solute transport equation

1. The convection diffusion equation contains a convective aspect for which the flow(water) 'velocity' and in our case a flux rate in the x-direction in [$\mathsf{m^2/d}$] is required. It is based on the internal flux of the groundwater flow equation.  
2. For the dispersive part of the convection diffusion equation it is also required to create a function for the volume per $\Delta x \Delta y$ to determine the amount of mass in the solute transport model.  Here this 'volume' is simply the saturated thickness multiplied with the porosity. 

<div class="question">  

1. Create the (water) flux function(x) for the internal flux. Call it __Qflow__ and make use of __approxfun__  and set __rule=2__.  
2. Create the "volume water" function(x). It is based on the volume of water contained in a slice of soil in the x-direction (and "y") and call it **Vflow**. Recall that the FVFE1D package will determine the $\Delta x$ of the slice based on the size of the volumes or elements.  

</div>

<div class="answer">

1. The internal flux can be derived with __dataframe.internalfluxes(Fmodel)__ with this dataframe you can create a function(x) which has unit $\mathsf{m^2/d}$. In this code it is called __Qflow__, with "flow" indicating the source (from the groundwater model).
2. The total volume at a certain x called here _Volume distribution_ is $\text{por}\,*\,D_{sat}(x)$ which has unit $\mathsf{m}$ or $\mathsf{m^3}/(\Delta x \Delta y)$. In this code it is called __Vflow__, also here, "flow" indicating the source (from the groundwater model).

```{r}
df.intq = dataframe.internalfluxes(Fmodel)
Qflow = approxfun(df.intq$x,df.intq$intflux,rule = 2)
plot(nodes,Qflow(nodes),type='l',lwd=2,col='red',main="Internal flux flow model",ylab='flux (m2/d)',xlab = "distance (m)")
Vflow = approxfun(nodes,por*D.sat(nodes),rule=2)
plot(nodes,Vflow(nodes),type='l',lwd=2,col='blue',main="Volume distribution",ylab='Volume (m3/m2)',xlab="distance (m)" )
```
</div>  

# Solute transport model  
The solute transport model will simulate the movement of a certain solute in the groundwater which comes from a continuous source. The source is simulated with a prescribed amount of mass "loaded" into the groundwater which is called "mass loading".  
The movement and displacement of the solute is based on the convection diffusion equation as described in the introduction and is now extended with the source term (the contaminant from the vessel) $S$:  

$$
\frac{\partial s}{\partial t}=-v \frac{\partial s}{\partial x}+D \frac{\partial^2 s}{\partial x^2} + S
$$

The abovemention (CDE) equation can be considered to be a **mass balance**, simply multiply all term with a volume and it results in mass per time  $\frac{kg}{d}$.  

## Internal mass flux for the transportmodel  

The internal *mass flux* for the solute transport model describes the movement of mass per time unit.


$$
M_{flux} =A \,\, por \left\{ vC-D\frac{\partial C}{\partial x}\right\}
$$

With:  

* $A$: the area perpendicular to the mass flux, $D_{sat}\, \Delta y$, in $\mathsf{m^2}$  
* $por$: porosity (-)  
* $v$: local velocity in $\mathsf{m/d}$  
* $C$: concentration of the solute in $\mathsf{kg/m^3}$  
* $D$: Diffusion/Dispersion coefficient in $\mathsf{m^2/d}$  


Looking at both the Darcy flux and this "mass flux", there are similarities and differences:

* both have a diffusion term with a minus sign up front
* the mass flux has an additional term, the convective term

### Advection/Convection

Solutes are displaced due to the groundwater velocity; $vC$, hence the $v$ which come from the Darcy flux and is calculated as: $v=\frac{q}{\text{por}}$

### Dispersion/Diffusion

Solutes are displaced by concentration gradients, similar like groundwater is displaced by the head gradient.  
This term $-D \frac{\partial C}{\partial x}$ is called the (first) Fick's law (similar like Darcy's law for groudnwater flow)


### Derivation of the internal flux function for transport

To distinguish the 'flow' and 'mass' flux rates between groundwater flow and solute transport, groundwater flow is indicated with 'flow', as in __Qflow(x)__, for the internal flux with unit $m^2/d$. Solute transport focuses on the amount of mass of a certain solute/pollutant in the groundwater and is here indicated with __Mflux(x)__ with unit $kg/(dm)$.  Again, the $/m$ comes from the "per meter $\Delta y$


The diffusion/dispersion here is a combination of the molecular diffusion(Brownian movement) and the mechanical dispersion(accounting for the local pore flow and its pore structure) and is assumed to be constant here.  

<div class="question">

* 'Derive' mass flux equation from the above equation, which is the internal flux for the solute transport model and determine its unit.
* What is the unit for the concentration for this model?
* What is the unit for the mass in the model?

</div>

<div class="answer">  

* Derivation of the mass flux/internal flux function:
$$
\begin{align}
M_{flux} &= A\,\text{por} \left ( vC -D\frac{\partial C}{\partial x}\right )\\
&= D_{sat}\,\text{por}\,v\,C - D_{sat}\,\text{por}\,D\frac{\partial C}{\partial x}\\
&= q_D\,C - D_{sat}\,\text{por}\,D\frac{\partial C}{\partial x}\\
&= \text{Qflow}\,C - \text{Vflow}\,D\frac{\partial C}{\partial x}\\
q_D \, C&:[\mathsf{m^2d^{-1}kgm^{-3}}]\rightarrow [\mathsf{kg/(md)}]\\
D_{sat}\,\text{por}\,D\frac{\partial C}{\partial x} &:[\mathsf{m\,-\, m^2d^{-1}kgm^{-3}m^{-1}}] \rightarrow [\mathsf{kg/(md)}]
\end{align}\\
$$
* $C$ is in $\mathsf{kg/m^3}$, and also for this model if we consider the volume being $D(x)*\text{por}\,\Delta x \, \Delta y$.
* Mass has the unit $\mathsf{kg}$ but to derive mass from the concentration in this model it is $C\,D_{sat}\,por\,\Delta x \rightarrow [\mathsf{kgm^{-3}\,m\,-\,m}] \rightarrow [\mathsf{kg/m}]$ which is stored in the soil for a certain moment in time. The amount of mass entering or leaving the model can be calculated with $\text{mass flux}\,\text{time step}\rightarrow qC\Delta t\rightarrow [\mathsf{m^2d^{-1}kgm^{-3}d}]\rightarrow [\mathsf{kg/m}]$.

</div>

## Model setup  stationary

The domain of the solute transport model is identical to the groundwater flow model.  On the right hand side no solute is entering or leaving the model so the boundary is closed, simply because there is no flow there. On the left hand side solute leaves the model due to convection; i.o.w. groundwater flow carries the solute out of the model, into the river.

### Boundary conditions tranport model

Also here we chose between the three different types of boundary condtions

*  Dirichlet, a prescribed concentration; $C(x,t$
*  Neumann, a prescribed concentration **gradient** $\frac{\partial C}{\partial x}$
*  Cauchy, combination of both: $vC - D \frac{\partial C}{\partial x}$  

A relevant difference between applying boundary conditions for transport models is that there is a large difference in applications when water with a certian concentration is flowing **in** or **out** of the model.

The Dirichlet condition is used mostly when the concentration is known at a certain point in time and that one is ensured the flow will always be oriented inwards. Simply consider what would happen with a model when you force it to come up with a prescibed concentration flowing out of the model...

Applying the Neumann boundary condition and assuming that no mass/solute is entering the model, is similar to applying this in a flow model.  

The Cauchy boundary condition is a special and important case for transport modeling. It serves as a tool to let water with a solute move out of the model. Most of the time the concentration gradient at the boundary (outflow) is assumed to be 0 resulting in $vC$ indicating that the local groundwater velocity at this boundary multiplied with the concentration at that point results in mass flux outside of the model.  


The dispersion coefficient is set to 5 $\mathsf{m^2/d}$

<div class="question">

* Determine the proper boundary conditions.
</div>
<div class="answer">

* $qC \rightarrow [\mathsf{m^2d^{-1}kgm^{-3}}]\rightarrow [\mathsf{kgd^{-1}m^{-1}}]\rightarrow [\mathsf{kg/(md)}]$
* Boundary right: nothing to do, natural boundary condition
* Boundary left : $A\,\text{por}\,\left ( vC -D\frac{\partial C}{\partial x}\right )$ and assume $\frac{\partial C}{\partial x}=0\rightarrow =q_D\,C \rightarrow \text{Qflow}(x=0)C$
</div>

### Point source  

Somewhere in the middle of the solute transport model a solute source (pollutant) is assigned to the model. It will be implemented as a _mass loading_ condition/forcing. One could imagine it being a substance dissolving into the groundwater. This way an amount of 'mass' is loaded into the model/groundwater during a certain amount of time.  In this case the substance is leaking into the groundwater continuously with a mass loading of 0.2 $\mathsf{kg/(md)}$


<div class="question">
Setup the solute transport model.  
* Add the point source  
* What is the unit for the continuous solute source?  
* Run the model and analyse the results; Concentration, internal flux, mass balance  
</div>

When looking at the results of this  model;  

<div class="answer">
First the setup of the model
```{r}
Disp = 5 #m2/d constant dispersion not depending on local velocities
# math model
CDE = function(x,C,gradC)
{
  Mass.flux = Qflow(x)*C - Vflow(x)*Disp*gradC
  return(Mass.flux)
}
Cmodel = newFLOW1D(domain = domain,systemfluxfunction = CDE,name = "solute transport")

#BC left
Cauchy = function(C)
{
  return(Qflow(domain[1])*C)
}
set.BC.fluxstate(model = Cmodel,where = 'left',Cauchy)
M.flux.in = 0.125 #kg/(m d)
#add.pointflux(model = Cmodel,at = 100,value = "M.flux.in",name = "Solute source")
add.pointflux(model = Cmodel,at = 85,value = "M.flux.in",name = "Solute source")
#numerical model
set.discretisation(model = Cmodel,nodes = nodes, method = "FV")

#solve
solve.steps(Cmodel)

```
Now looking at the results;

```{r}
plot(Cmodel,fluxplot = T,FVstyle = T)
dataframe.balance(Cmodel)
dataframe.boundaries(Cmodel)
dataframe.balance(Cmodel)
mbal_39 = dataframe.balance(Cmodel,region = c(39))
c_38_39_40 = dataframe.states(Cmodel)[38:40,]
Mflux_39 = dataframe.internalfluxes(Cmodel)[39,]
Qflow_x_C_5 = Qflow(nodes[5])*c_38_39_40$state[2] - Vflow(nodes[5])* (c_38_39_40$state[3]-c_38_39_40$state[2])/5

```
</div>  

<div class="question">

1. What are these calculated states?
2. What is the unit of this balance?
3. Check for the left boundary (your own calculation) the mass flux leaving the left boundary and what unit does it have?

</div>
<div class="answer">

1. These are the concentrations ($\mathsf{kg/m^3}$)
2. The unit of the mass flux which is $\mathsf{kg/(md)}$
3. Mass flux leaving the boundary, which is based on the Cauchy function (boundary)

```{r}
# mass flux leaving the boundary, based on the Cauchy function (boundary)
Qflow(0)*Cmodel$states[1]
```
The unit of this mass flux is identical to the unit of the Mass flux equation and here:  $\text{qC}\rightarrow \mathsf{m^2/d\,kg/m^3} \rightarrow \mathsf{kg/(m d)}$
</div>

## Model setup transient  
Similar like all models up till now, the main difference between a stationary and transient model is the addition of the storage flux and the simulation through time.  

<div class="question">
* Define the storage flux for the transient model.  
In determining this flux(rate) and its units; Be aware that the storage flux is a spatial flux, so the 'area' over which the flux rate is integrated is carried out by the FVFE1D package.
</div>  

<div class="answer">
The storage flux is: $-D_{sat}\,por \,\frac{\partial C}{\partial t}$. Solute stored means that this is removed from the system, hence the minus sign.
The numerical equivalent is: $-\text{Vflow(x)}\frac{C_i^{t+\Delta t}-C_i^{t}}{\Delta t}$.  
```{r}
C.sto = function(x,Conc)
{
  return(Vflow(x)*(prev.C(x) - Conc)/delta.t)
}
```
</div>

The source of solute is removed from the transient solute transport model, implying that the pollutant has been cleaned up at the surface.  

To see whether numerical problems occur one need to determine the Peclet and Courant numbers for the given properties of the model. 

* Peclet$_{grid}$ number: $\frac{v\Delta x}{D} < 2$ 
* Courant number: $\frac{v\Delta t}{\Delta x} < 1$
* Based on previous $\Delta t < \frac{\Delta x}{v}$


<div class="question">
Set up a transient solute transport model based on the stationary model. 
At the start of the transient simulation the initial concentration of the solute is the final concentration distribution of the stationary solute transport model.
Consider the following aspects of this model:  

* make a copy of the stationary transport model to develop the transient one  
* remove the source from this model
* calculate the Peclet and Courant numbers for each node for inspection and to determine a proper time step $\Delta t$
* create a time stepping loop running for at least one year
* plot the transient steps in one graph in the time stepping loop
* Store the mass balance terms into different arrays to plot these afterwards. See assignment 2 for details.
</div>

<div class="answer">

```{r}
# make a model copy of the stationary solute transport model
Ctransmodel = copy.model(Cmodel)

# save the current concentration distribution in prev.C
prev.C = state.fun(Cmodel)

# remove the source from the transient solute transport model
rem.pointflux(Ctransmodel,"Solute source")

# add storage to the model
add.spatialflux(Ctransmodel,C.sto,name = "mass storage")

# some containers for the mass balance terms
bnd.out = c()
storage.in = c()
storage.out = c()
time.step = c()

# transient aspccts
beg.time = 0
end.time = 5*365

current.time= beg.time

#check numerical aspects
v = Qflow(nodes)/(D.sat(nodes)*por) #Qflow = m2/d so v=Qflow/(D.sat*por)
#calculation of reasonable time step
#V*delta.t/delta.x < 1 so delta.t < delta.x/v
bound.delta = delta.x/abs(v)
plot(nodes,bound.delta,type =  "o",col="green", main = "bound.delta at nodes")

#largest time step should be smallest of bound.delta. Since delta.x is constant it is at the location where velocity is highest
delta.t = floor(min(bound.delta))

Peclet = abs(v) * delta.x/Disp
Courant = abs(v) * delta.t/delta.x 
plot(nodes,Peclet,type="o",col="blue",main="Peclet at nodes")
plot(nodes,Courant,type="o",col="red", main = c("Courant at nodes; with delta t :",delta.t))


#plot the starting solute concetration distribution
plot(nodes,prev.C(nodes),type = 'o',col='red',ylab = "concentration kg/m3",
     xlab= "distance (m)", main = "Transient solute concentration distribution",
     ylim = c(0,max(prev.C(nodes))))

while (current.time < end.time)
{
  prev.C = state.fun(Ctransmodel)
  solve.steps(Ctransmodel)
  #write data 
  df.states = dataframe.states(Ctransmodel)
  lines(df.states$x,df.states$state)
  df.mass = dataframe.balance(Ctransmodel)
  bnd.out = c(bnd.out,df.mass[3,3])
  storage.in = c(storage.in,df.mass[2,2])
  storage.out = c(storage.out,df.mass[2,3])
  current.time = current.time + delta.t
  time.step = c(time.step,current.time)
  # print(current.time)
}
# mass balance plot.
mass.balance = data.frame(time.step,bnd.out,storage.in,storage.out)
plot(mass.balance$time.step,mass.balance$bnd.out,main="mass balance, green:boundary out, blue:storage change",type="l",
     col="green",lwd=3,ylab="mass kg/(dm)",xlab="time step (d)")
lines(mass.balance$time.step,mass.balance$storage.in, col="blue",lwd=3,lty="dashed")
grid()

```

</div>


## Transient solute transport model with pump & treat  
 As can be seen from the results of the transient model, the solute disappears slowly at the left boundary. To speed up this process an extraction well is implemented at the location of the original source and will have an extraction rate equal to 50% of the recharge of the model.   
If the solute was some sort op pollutant this way of removing is called pump & treat, where the solute is removed/processed from the extracted groundwater. Pump & treat systems may also inject this cleaned water upstream but could be discarded here.
 
<div class="question">  

* Adjust the groundwater flow model accordingly.
* Run the adjusted flow model and recalculate D.sat, internal flux and Volume functions.
</div>

<div class="answer">  

```{r}
# add the extraction well to the flow model
p_t.rate = -0.10 #m2/d extraction rate
add.pointflux(Fmodel,at = 100,value = "p_t.rate",name="pump")

#run the flow model and have a look at the results
solve.steps(Fmodel)
plot(Fmodel,fluxplot = T)
dataframe.balance(Fmodel)

#recalculate the Volumflux and massflux functions
D.sat = approxfun(nodes,Fmodel$states-bottom(nodes))
plot(nodes,D.sat(nodes),type="o", main='saturated thicknes (m)')
df.intq = dataframe.internalfluxes(Fmodel)
Qflow = approxfun(df.intq$x,df.intq$intflux,rule = 2)
plot(nodes,Qflow(nodes),type='l',lwd=2,col='red',main="Internal flux flow model",ylab='flux (m2/d)',xlab = "distance (m)")
Vflow = approxfun(nodes,por*D.sat(nodes),rule=2)
plot(nodes,Vflow(nodes),type='l',lwd=2,col='blue',main="Volume m3/m2",ylab='Volume (m)',xlab="distance (m)" )

```


<div class="question">  

* Make a copy of the stationary solute transport model.
* Remove the source.
* Add the pump&treat point flux which now is a function of the solute concentration at this location.

</div>

<div class="answer">

```{r}
# make a model copy of the stationary solute transport model
Ctransmodel = copy.model(Cmodel)

# save the current concentration distribution in prev.C
prev.C = state.fun(Cmodel)

# remove the source from the transient solute transport model
rem.pointflux(Ctransmodel,"Solute source")

# add the pump&treat extraction well for removing the solute
p_t.sink = function(conc)
{
 return(p_t.rate*conc) 
}
add.pointflux(Ctransmodel,at = 100,p_t.sink,name = "pump_treat")

# add storage to the model
add.spatialflux(Ctransmodel,C.sto,name = "mass storage")

```
</div>

<div class="question">  

* calculate the Peclet and Courant numbers for each node for inspection and to determine a proper time step $\Delta t$.
</div>

<div class="answer">

```{r}
#check numerical aspects
v = Qflow(nodes)/(D.sat(nodes)*por) #Qflow = m2/d so v=Qflow/(D.sat*por)

#calculation of reasonable time step
#V*delta.t/delta.x < 1 so delta.t < delta.x/v
bound.delta = delta.x/abs(v)
plot(nodes,bound.delta,type =  "o",col="green", main = "bound.delta at nodes")
delta.t = floor(min(bound.delta))

Peclet = abs(v) * delta.x/Disp
Courant = abs(v) * delta.t/delta.x 
plot(nodes,Peclet,type="o",col="blue",main="Peclet at nodes")
plot(nodes,Courant,type="o",col="red", main = c("Courant at nodes; with delta t :",delta.t))


```
</div>

<div class="question">  

* create a time stepping loop running for at least one year.
* plot the transient steps in one graph in the time stepping loop.
* Store the mass balance terms into different arrays to plot these afterwards. See assignment 2 for details.
</div>

<div class="answer">

```{r}
# some containers for the mass balance terms
bnd.out = c()
storage.in = c()
storage.out = c()
time.step = c()
pump.treat = c()

# transient aspccts
beg.time = 0
end.time = 5*365

current.time= beg.time


#plot the starting solute concetration distribution
plot(nodes,prev.C(nodes),type = 'o',col='red',ylab = "concentration kg/m3",
     xlab= "distance (m)", main = "Transient solute concentration distribution",
     ylim = c(0,max(prev.C(nodes))))

while (current.time < end.time)
{
  prev.C = state.fun(Ctransmodel)
  solve.steps(Ctransmodel)
  #write data 
  df.states = dataframe.states(Ctransmodel)
  lines(df.states$x,df.states$state)
  df.mass = dataframe.balance(Ctransmodel)
  bnd.out = c(bnd.out,df.mass[4,3])
  storage.in = c(storage.in,df.mass[2,2])
  storage.out = c(storage.out,df.mass[2,3])
  pump.treat = c(pump.treat,df.mass[3,3])
  current.time = current.time + delta.t
  time.step = c(time.step,current.time)
  # print(current.time)
}
# mass balance plot.
mass.balance = data.frame(time.step,bnd.out,storage.in,storage.out,pump.treat)
y.range = range(mass.balance$bnd.out,mass.balance$pump.treat,mass.balance$storage.in)
plot(mass.balance$time.step,mass.balance$bnd.out,main="mass bal., green:bndout, blue:stor.change,red:p_t",type="l",
     col="green",lwd=3,ylab="mass kg/(dm)",xlab="time step (d)",ylim=y.range)
lines(mass.balance$time.step,mass.balance$storage.in, col="blue",lwd=3,lty="dashed")
lines(mass.balance$time.step,mass.balance$pump.treat,col="red",lwd=3)
grid()
error = mass.balance$bnd.out+mass.balance$pump.treat-mass.balance$storage.in
dataframe.balance(Ctransmodel)
```

</div>

<div class="question">
Calculate the following total amounts of solute mass ($kg$):  

* How much mass did the model contain at the start of the remediation?  
* what is left out of the boundary?  
* what is extracted with the pump & treat?  
* what is still stored?  
* Do they balance?
</div>  

<div class="answer">
The required data is already stored in the **mass.balance** dataframe and simply need to be multiplied with $\Delta t$.

What still is stored/left in the model requires nodal cell "area's" which are lengths in this 1D model. Then the amount of mass still left is calculated by: $C_{left}\,L_{nodes}\,D_{sat}\,por$.  

```{r}

##to calculate much mass is stored in the model, cell lengths are required
dx.node = diff(nodes)
dx.node[1]=2.5
dx.node = c(dx.node,2.5)

#mass at the beginning of the remediation
mass.begin = Cmodel$states*dx.node*D.sat(nodes)*por
plot(mass.begin,type="o")
tot.begin = sum(mass.begin)

#mass which is removed by the boundary and pump & treat
tot.bnd.out = sum(mass.balance$bnd.out*delta.t)
tot.pump.treat = sum(mass.balance$pump.treat*delta.t)

#mass what is left in the model
mass.left = Ctransmodel$states*dx.node*D.sat(nodes)*por
plot(mass.left,type="o")
tot.left = sum(mass.left)
#to check if it all balances;
error = tot.bnd.out + tot.pump.treat + tot.left -tot.begin
```

To finally check if all is in balance in $kg/m$ which is the mass per unit length $\Delta y$:

mass begin | mass boundary out | mass pump&treat | mass left behind | difference  
---------- | ----------------- | ----------------- | ---------------- | ----------  
`r tot.begin` | `r tot.bnd.out` | `r tot.pump.treat` | `r tot.left` | `r error` 

</div>

